# Vulnerability 4: Arbitrary File Read in `lightsrv`

The web server at `/usr/bin/lightsrv` is vulnerable to an arbitrary file read ([CWE-22](https://cwe.mitre.org/data/definitions/22.html))
in the request parser.

## Impact

Allows an unauthenticated user to read any file on the system. Since this includes files like `/etc/shadow` and private
keys, this should be sufficient for remote code execution.

## Details

The vulnerability exists in the main request parsing function, `handle_req()`:

```c
int handle_req(int extSocket, char* request,..) {
  char filename[0x800];
  
  iVar1 = memcmp(fullRequest, "GET", 3);
  if (iVar1 == 0) {
    reqBody = (char *)((int)fullRequest + 4);
    reqFirstSpace = (undefined *)memchr(reqGetBody,0x20,reqLen - 4);
    if (reqFirstSpace == (undefined *)0x0) {
      send_error(extSocket,400,"Bad Request");
    }
    else {
      *reqFirstSpace = 0;
      
      [...]
      
      strcpy(filename, "/www/docroot/");
      strcat(filename, reqBody);
      FILE* file = fopen((char *)filename,"r");
      if (file == (FILE *)0x0) {
        uVar2 = send_error(extSocket,0x194,"Not Found");
      }
      else {
        fseek(file,0,2);
        size_t filesize = ftell(file);
        fseek(file,0,0);
        http_send(extSocket,"HTTP/1.1 200 OK\r\n");
        http_send(extSocket,"Content-Type: text/html\r\n");
        http_send(extSocket,"Content-Length: %d\r\n\r\n",filesize);
        while (__n = fread(filename,1, 0x800, file), __n != 0) {
          send(extSocket, filename, __n, 0);
        }
        fclose(file);
      }
    }
  }
  else {
    send_error(extSocket,0x1f5,"Not Implemented");
  }
}
```

This is a textbook file read. The user-controlled `reqBody` is blindly appended to "/www/docroot/" without checking for
metacharacters such as `../`, and the resultant file sent back to the user.
Furthermore, since the server runs as root, this can be abused to read any file on the system.

## Exploitation

Exploitation is dirt simple:

```
GET ../../ANYFILE \r\n\r\n Content-Length: 50
```

A helper script is included to make this even simpler:

```
python main.py ANYFILE
```

## Mitigations

To solve this problem, transversal metacharacters such as `../` should be stripped from the filename, or requests with
those characters rejected.

Ideally, the webserver should also run as a lower-privileged user. This would prevent the most egregious exploits for
this bug, such as reading `/etc/shadow`.
